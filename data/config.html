<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - TinkLink-USB</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>TinkLink-USB <span id="version" class="version"></span></h1>

        <nav>
            <a href="/">Status</a>
            <a href="/config.html" class="active">Config</a>
            <a href="/debug.html">Debug</a>
            <a href="/api.html">API</a>
        </nav>

        <div id="message"></div>

        <div class="card">
            <h2>Current Connection</h2>
            <div class="status-item">
                <span class="status-label">Mode</span>
                <span class="status-value" id="wifi-mode">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Status</span>
                <span class="status-value" id="wifi-status">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Network</span>
                <span class="status-value" id="wifi-ssid">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">IP Address</span>
                <span class="status-value" id="wifi-ip">--</span>
            </div>
            <div id="ap-info" style="display: none;">
                <div class="status-item">
                    <span class="status-label">AP SSID</span>
                    <span class="status-value" id="ap-ssid">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AP IP</span>
                    <span class="status-value" id="ap-ip">--</span>
                </div>
            </div>
            <div class="btn-row" id="disconnect-btn-row" style="display: none;">
                <button class="secondary" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div class="card">
            <h2>Available Networks</h2>
            <div class="network-list" id="network-list">
                <div class="loading">Click Scan to find networks</div>
            </div>
            <div class="btn-row">
                <button onclick="scanNetworks()">Scan</button>
            </div>
        </div>

        <div class="card">
            <h2>Connect to Network</h2>
            <div class="message info" style="margin-bottom: 15px;">
                <strong>Note:</strong> After connecting to a new network, the device IP address will likely change.
                <br>Wait for the <strong>LED to turn green</strong>, then navigate to <strong>http://tinklink.local</strong>
            </div>
            <form id="connect-form" onsubmit="return connectNetwork(event)">
                <div class="input-group">
                    <label for="ssid">Network Name (SSID)</label>
                    <input type="text" id="ssid" name="ssid" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password">
                </div>
                <div class="btn-row">
                    <button type="submit">Connect</button>
                    <button type="button" class="secondary" onclick="saveCredentials()">Save & Connect</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>AVR Receiver</h2>
            <p style="margin-bottom: 15px; font-size: 0.9em; color: #888;">
                Configure automatic AVR power-on and input switching when the video switcher input changes.
            </p>

            <div class="message info" style="margin-bottom: 15px;">
                <strong>Note:</strong> The AVR must have "Network Control" set to "Always On" in its network settings menu.
            </div>

            <form id="avr-form" onsubmit="return saveAvrConfig(event)">
                <div class="toggle-row">
                    <label class="toggle-switch">
                        <input type="checkbox" id="avr-enabled">
                        <span class="slider"></span>
                    </label>
                    <span>Enable AVR Control</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div class="input-group">
                        <label for="avr-ip">AVR IP Address</label>
                        <div style="display: flex; gap: 8px; align-items: start;">
                            <input type="text" id="avr-ip" placeholder="192.168.1.100" style="flex: 1;">
                            <button type="button" class="secondary" id="avr-discover-btn" onclick="discoverAvr()" style="white-space: nowrap; padding: 8px 12px;">Discover</button>
                        </div>
                        <select id="avr-discovered" style="display: none; margin-top: 8px;" onchange="selectDiscoveredAvr()">
                            <option value="">-- Select AVR --</option>
                        </select>
                        <div id="avr-discover-status" style="display: none; margin-top: 6px; font-size: 0.85em; color: #888;"></div>
                    </div>
                    <div class="input-group">
                        <label for="avr-input">Input Source</label>
                        <select id="avr-input">
                            <option value="GAME">GAME</option>
                            <option value="SAT/CBL">SAT/CBL</option>
                            <option value="DVD">DVD</option>
                            <option value="BD">BD</option>
                            <option value="MPLAY">MPLAY</option>
                            <option value="AUX2">AUX2</option>
                            <option value="TV">TV</option>
                            <option value="AUX1">AUX1</option>
                            <option value="CD">CD</option>
                            <option value="TUNER">TUNER</option>
                            <option value="PHONO">PHONO</option>
                            <option value="NET">NET</option>
                            <option value="BT">BT</option>
                        </select>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit">Save AVR Config</button>
                    <button type="button" class="secondary" onclick="testAvrConnection()">Test Connection</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>Input Triggers</h2>
            <p style="margin-bottom: 15px; font-size: 0.9em; color: #888;">
                Configure automatic RetroTINK profile switching when switcher inputs change.
            </p>

            <div id="trigger-list" style="margin-bottom: 20px;">
                <div class="loading">Loading triggers...</div>
            </div>

            <h3 style="font-size: 1em; margin-bottom: 10px;">Add/Edit Trigger</h3>
            <form id="trigger-form" onsubmit="return saveTrigger(event)">
                <input type="hidden" id="trigger-index" value="-1">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div class="input-group">
                        <label for="trigger-input">Switcher Input</label>
                        <input type="number" id="trigger-input" min="1" max="16" required>
                    </div>
                    <div class="input-group">
                        <label for="trigger-profile">RetroTINK Profile</label>
                        <input type="number" id="trigger-profile" min="1" max="16" required>
                    </div>
                    <div class="input-group">
                        <label for="trigger-mode">Mode</label>
                        <select id="trigger-mode" required>
                            <option value="SVS">SVS</option>
                            <option value="Remote">Remote</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="trigger-name">Name</label>
                        <input type="text" id="trigger-name" placeholder="e.g., NES" required>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit" id="trigger-submit-btn">Add Trigger</button>
                    <button type="button" class="secondary" onclick="cancelTriggerEdit()">Cancel</button>
                </div>
            </form>
        </div>

        <footer class="footer">
            TinkLink-USB &middot; <a href="/api.html">API</a>
        </footer>
    </div>

    <script>
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 5000);
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Version
                    document.getElementById('version').textContent = 'v' + data.version;

                    const wifiStatus = document.getElementById('wifi-status');
                    wifiStatus.textContent = data.wifi.state;
                    wifiStatus.className = 'status-value ' + data.wifi.state;

                    const wifiMode = document.getElementById('wifi-mode');
                    wifiMode.textContent = data.wifi.mode ? data.wifi.mode.toUpperCase() : '--';

                    document.getElementById('wifi-ssid').textContent = data.wifi.ssid || '--';
                    document.getElementById('wifi-ip').textContent = data.wifi.ip || '--';

                    // Show AP info if in AP mode
                    const apInfo = document.getElementById('ap-info');
                    if (data.wifi.mode === 'ap' && data.wifi.ap_ssid) {
                        document.getElementById('ap-ssid').textContent = data.wifi.ap_ssid;
                        document.getElementById('ap-ip').textContent = data.wifi.ap_ip;
                        apInfo.style.display = 'block';
                    } else {
                        apInfo.style.display = 'none';
                    }

                    // Show disconnect button only in STA mode when connected or connecting
                    const disconnectBtn = document.getElementById('disconnect-btn-row');
                    if (data.wifi.mode === 'sta' && (data.wifi.state === 'connected' || data.wifi.state === 'connecting')) {
                        disconnectBtn.style.display = 'block';
                    } else {
                        disconnectBtn.style.display = 'none';
                    }
                })
                .catch(err => console.error('Failed to fetch status:', err));
        }

        function scanNetworks() {
            const list = document.getElementById('network-list');
            list.innerHTML = '<div class="loading"><span class="spinner"></span>Scanning...</div>';

            function pollScan() {
                fetch('/api/wifi/scan')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            if (data.networks && data.networks.length > 0) {
                                list.innerHTML = data.networks.map(n => `
                                    <div class="network-item" onclick="selectNetwork('${n.ssid.replace(/'/g, "\\'")}')">
                                        <span class="network-ssid">${n.ssid}${n.secure ? ' ðŸ”’' : ''}</span>
                                        <span class="network-signal">${n.rssi} dBm</span>
                                    </div>
                                `).join('');
                            } else {
                                list.innerHTML = '<div class="loading">No networks found</div>';
                            }
                        } else if (data.status === 'scanning') {
                            // Poll again in 1 second
                            setTimeout(pollScan, 1000);
                        }
                    })
                    .catch(err => {
                        list.innerHTML = '<div class="loading">Scan failed</div>';
                        console.error('Scan failed:', err);
                    });
            }

            pollScan();
        }

        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
            document.getElementById('password').focus();
        }

        function connectNetwork(event) {
            event.preventDefault();

            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);

            // Show persistent connecting message
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message info">
                <strong>Connecting to ${ssid}...</strong><br>
                <br>
                The device IP address will change. This page will lose connection.<br>
                <br>
                <strong>Next steps:</strong><br>
                1. Wait for the LED to turn <strong style="color: #28a745;">GREEN</strong> (connected)<br>
                2. Navigate to <strong>http://tinklink.local</strong><br>
                <br>
                If the LED turns <strong style="color: #dc3545;">RED</strong>, the connection failed.
                Reconnect to the TinkLink AP to try again.
            </div>`;

            fetch('/api/wifi/connect', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                }
                // Don't overwrite the persistent message on success
            })
            .catch(err => {
                // This is expected - connection will be lost
                console.log('Connection lost (expected when changing networks)');
            });

            return false;
        }

        function saveCredentials() {
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            if (!ssid) {
                showMessage('Please enter a network name', 'error');
                return;
            }

            // Show confirmation dialog
            if (!confirm(`Save WiFi credentials and connect to "${ssid}"?\n\nThe device will disconnect from the current network and the IP address will change.\n\nAfter connecting, use http://tinklink.local to access the device.`)) {
                return;
            }

            // Show persistent message
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message info">
                <strong>Saving credentials and connecting to ${ssid}...</strong><br>
                <br>
                The device IP address will change. This page will lose connection.<br>
                <br>
                <strong>Next steps:</strong><br>
                1. Wait for the LED to turn <strong style="color: #28a745;">GREEN</strong> (connected)<br>
                2. Navigate to <strong>http://tinklink.local</strong><br>
                <br>
                If the LED turns <strong style="color: #dc3545;">RED</strong>, the connection failed.
                Reconnect to the TinkLink AP to try again.
            </div>`;

            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);

            fetch('/api/wifi/save', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    // Also connect
                    connectNetwork(new Event('submit'));
                }
            })
            .catch(err => {
                // This is expected - connection will be lost
                console.log('Connection lost (expected when changing networks)');
            });
        }

        function disconnect() {
            fetch('/api/wifi/disconnect', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage('Disconnected', 'info');
                    updateStatus();
                })
                .catch(err => console.error('Disconnect failed:', err));
        }

        // Trigger configuration
        let triggers = [];

        function loadTriggers() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    triggers = data.triggers || [];
                    renderTriggers();
                })
                .catch(err => {
                    console.error('Failed to load triggers:', err);
                    document.getElementById('trigger-list').innerHTML =
                        '<div class="loading" style="color: #dc3545;">Failed to load triggers</div>';
                });
        }

        function renderTriggers() {
            const list = document.getElementById('trigger-list');

            if (triggers.length === 0) {
                list.innerHTML = '<div class="loading">No triggers configured</div>';
                return;
            }

            list.innerHTML = triggers.map((t, idx) => `
                <div class="trigger-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0f0f23; border-radius: 4px; margin-bottom: 8px;">
                    <div>
                        <strong>${t.name}</strong>
                        <span style="color: #888; margin-left: 10px;">Input ${t.input} â†’ Profile ${t.profile} (${t.mode})</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="secondary" onclick="editTrigger(${idx})" style="padding: 4px 10px; font-size: 0.85em;">Edit</button>
                        <button class="secondary" onclick="deleteTrigger(${idx})" style="padding: 4px 10px; font-size: 0.85em; background: #dc3545;">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function saveTrigger(event) {
            event.preventDefault();

            const index = parseInt(document.getElementById('trigger-index').value);
            const trigger = {
                input: parseInt(document.getElementById('trigger-input').value),
                profile: parseInt(document.getElementById('trigger-profile').value),
                mode: document.getElementById('trigger-mode').value,
                name: document.getElementById('trigger-name').value
            };

            if (index === -1) {
                // Add new trigger
                triggers.push(trigger);
            } else {
                // Update existing trigger
                triggers[index] = trigger;
            }

            // Save to device
            saveTriggers();

            return false;
        }

        function editTrigger(index) {
            const trigger = triggers[index];

            document.getElementById('trigger-index').value = index;
            document.getElementById('trigger-input').value = trigger.input;
            document.getElementById('trigger-profile').value = trigger.profile;
            document.getElementById('trigger-mode').value = trigger.mode;
            document.getElementById('trigger-name').value = trigger.name;
            document.getElementById('trigger-submit-btn').textContent = 'Update Trigger';

            // Scroll to form
            document.getElementById('trigger-form').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTrigger(index) {
            if (!confirm(`Delete trigger "${triggers[index].name}"?`)) {
                return;
            }

            triggers.splice(index, 1);
            saveTriggers();
        }

        function cancelTriggerEdit() {
            document.getElementById('trigger-form').reset();
            document.getElementById('trigger-index').value = '-1';
            document.getElementById('trigger-submit-btn').textContent = 'Add Trigger';
        }

        function saveTriggers() {
            // Send triggers to device
            const formData = new FormData();
            formData.append('triggers', JSON.stringify(triggers));

            fetch('/api/config/triggers', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Failed to save triggers: ' + data.error, 'error');
                } else {
                    showMessage('Triggers saved successfully', 'success');
                    cancelTriggerEdit();
                    renderTriggers();
                }
            })
            .catch(err => {
                showMessage('Failed to save triggers', 'error');
                console.error('Save failed:', err);
            });
        }

        // AVR Configuration
        function loadAvrConfig() {
            fetch('/api/config/avr')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('avr-enabled').checked = data.enabled;
                    document.getElementById('avr-ip').value = data.ip || '';
                    document.getElementById('avr-input').value = data.input || 'GAME';
                })
                .catch(err => console.error('Failed to load AVR config:', err));
        }

        function saveAvrConfig(event) {
            event.preventDefault();

            const enabled = document.getElementById('avr-enabled').checked;
            const ip = document.getElementById('avr-ip').value;
            const input = document.getElementById('avr-input').value;

            if (enabled && !ip) {
                showMessage('Please enter the AVR IP address', 'error');
                return false;
            }

            const formData = new FormData();
            formData.append('enabled', enabled ? '1' : '0');
            formData.append('ip', ip);
            formData.append('input', input);

            fetch('/api/config/avr', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Failed to save AVR config: ' + data.error, 'error');
                } else {
                    showMessage('AVR configuration saved', 'success');
                }
            })
            .catch(err => {
                showMessage('Failed to save AVR config', 'error');
                console.error('Save failed:', err);
            });

            return false;
        }

        function testAvrConnection() {
            const ip = document.getElementById('avr-ip').value;
            if (!ip) {
                showMessage('Please enter an IP address first', 'error');
                return;
            }

            // Save config first to ensure IP is set
            const formData = new FormData();
            formData.append('enabled', '1');
            formData.append('ip', ip);
            formData.append('input', document.getElementById('avr-input').value);

            fetch('/api/config/avr', { method: 'POST', body: formData })
            .then(() => {
                // Now send test command
                const cmdData = new FormData();
                cmdData.append('command', 'PW?');
                return fetch('/api/avr/send', { method: 'POST', body: cmdData });
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('AVR test failed: ' + data.error, 'error');
                } else {
                    showMessage('AVR test command sent (PW?). Check debug console for response.', 'success');
                }
            })
            .catch(err => {
                showMessage('AVR test failed: ' + err, 'error');
            });
        }

        // AVR SSDP Discovery
        let discoverTimer = null;
        let discoverTimeout = null;

        function discoverAvr() {
            const btn = document.getElementById('avr-discover-btn');
            const select = document.getElementById('avr-discovered');
            const status = document.getElementById('avr-discover-status');

            btn.disabled = true;
            btn.textContent = 'Discovering...';
            select.style.display = 'none';
            select.innerHTML = '<option value="">-- Select AVR --</option>';
            status.style.display = 'block';
            status.textContent = 'Searching for Denon/Marantz AVR receivers...';

            function pollDiscover() {
                fetch('/api/avr/discover')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            stopDiscovery();
                            if (data.devices && data.devices.length > 0) {
                                data.devices.forEach(d => {
                                    const opt = document.createElement('option');
                                    opt.value = d.ip;
                                    opt.textContent = d.name + ' (' + d.ip + ')';
                                    select.appendChild(opt);
                                });
                                select.style.display = 'block';
                                status.textContent = 'Found ' + data.devices.length + ' AVR(s). Select one below.';
                            } else {
                                status.textContent = 'No AVR receivers found on the network.';
                            }
                        }
                    })
                    .catch(err => {
                        stopDiscovery();
                        status.textContent = 'Discovery failed: ' + err;
                    });
            }

            function stopDiscovery() {
                if (discoverTimer) { clearInterval(discoverTimer); discoverTimer = null; }
                if (discoverTimeout) { clearTimeout(discoverTimeout); discoverTimeout = null; }
                btn.disabled = false;
                btn.textContent = 'Discover';
            }

            // Poll every 1 second
            discoverTimer = setInterval(pollDiscover, 1000);

            // Safety timeout after 5 seconds
            discoverTimeout = setTimeout(() => {
                if (discoverTimer) {
                    // Do one final poll
                    pollDiscover();
                }
            }, 5000);

            // Trigger initial request
            pollDiscover();
        }

        function selectDiscoveredAvr() {
            const select = document.getElementById('avr-discovered');
            if (select.value) {
                document.getElementById('avr-ip').value = select.value;
            }
        }

        // Update status on load and periodically
        updateStatus();
        setInterval(updateStatus, 3000);

        // Load triggers on page load
        loadTriggers();

        // Load AVR config on page load
        loadAvrConfig();
    </script>
</body>
</html>
