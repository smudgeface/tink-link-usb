<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Config - TinkLink-USB</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>TinkLink-USB <span id="version" class="version"></span></h1>

        <nav>
            <a href="/">Status</a>
            <a href="/config.html">WiFi Config</a>
            <a href="/debug.html">Debug</a>
        </nav>

        <div id="message"></div>

        <div class="card">
            <h2>Current Connection</h2>
            <div class="status-item">
                <span class="status-label">Mode</span>
                <span class="status-value" id="wifi-mode">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Status</span>
                <span class="status-value" id="wifi-status">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Network</span>
                <span class="status-value" id="wifi-ssid">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">IP Address</span>
                <span class="status-value" id="wifi-ip">--</span>
            </div>
            <div id="ap-info" style="display: none;">
                <div class="status-item">
                    <span class="status-label">AP SSID</span>
                    <span class="status-value" id="ap-ssid">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">AP IP</span>
                    <span class="status-value" id="ap-ip">--</span>
                </div>
            </div>
            <div class="btn-row" id="disconnect-btn-row" style="display: none;">
                <button class="secondary" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div class="card">
            <h2>Available Networks</h2>
            <div class="network-list" id="network-list">
                <div class="loading">Click Scan to find networks</div>
            </div>
            <div class="btn-row">
                <button onclick="scanNetworks()">Scan</button>
            </div>
        </div>

        <div class="card">
            <h2>Connect to Network</h2>
            <div class="message info" style="margin-bottom: 15px;">
                <strong>‚ö†Ô∏è Note:</strong> After connecting to a new network, the device IP address will likely change.
                <br>Wait for the <strong>LED to turn green</strong>, then navigate to <strong>http://tinklink.local</strong>
            </div>
            <form id="connect-form" onsubmit="return connectNetwork(event)">
                <div class="input-group">
                    <label for="ssid">Network Name (SSID)</label>
                    <input type="text" id="ssid" name="ssid" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password">
                </div>
                <div class="btn-row">
                    <button type="submit">Connect</button>
                    <button type="button" class="secondary" onclick="saveCredentials()">Save & Connect</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => msg.innerHTML = '', 5000);
        }

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Version
                    document.getElementById('version').textContent = 'v' + data.version;

                    const wifiStatus = document.getElementById('wifi-status');
                    wifiStatus.textContent = data.wifi.state;
                    wifiStatus.className = 'status-value ' + data.wifi.state;

                    const wifiMode = document.getElementById('wifi-mode');
                    wifiMode.textContent = data.wifi.mode ? data.wifi.mode.toUpperCase() : '--';

                    document.getElementById('wifi-ssid').textContent = data.wifi.ssid || '--';
                    document.getElementById('wifi-ip').textContent = data.wifi.ip || '--';

                    // Show AP info if in AP mode
                    const apInfo = document.getElementById('ap-info');
                    if (data.wifi.mode === 'ap' && data.wifi.ap_ssid) {
                        document.getElementById('ap-ssid').textContent = data.wifi.ap_ssid;
                        document.getElementById('ap-ip').textContent = data.wifi.ap_ip;
                        apInfo.style.display = 'block';
                    } else {
                        apInfo.style.display = 'none';
                    }

                    // Show disconnect button only in STA mode when connected or connecting
                    const disconnectBtn = document.getElementById('disconnect-btn-row');
                    if (data.wifi.mode === 'sta' && (data.wifi.state === 'connected' || data.wifi.state === 'connecting')) {
                        disconnectBtn.style.display = 'block';
                    } else {
                        disconnectBtn.style.display = 'none';
                    }
                })
                .catch(err => console.error('Failed to fetch status:', err));
        }

        function scanNetworks() {
            const list = document.getElementById('network-list');
            list.innerHTML = '<div class="loading"><span class="spinner"></span>Scanning...</div>';

            function pollScan() {
                fetch('/api/scan')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'complete') {
                            if (data.networks && data.networks.length > 0) {
                                list.innerHTML = data.networks.map(n => `
                                    <div class="network-item" onclick="selectNetwork('${n.ssid.replace(/'/g, "\\'")}')">
                                        <span class="network-ssid">${n.ssid}${n.secure ? ' üîí' : ''}</span>
                                        <span class="network-signal">${n.rssi} dBm</span>
                                    </div>
                                `).join('');
                            } else {
                                list.innerHTML = '<div class="loading">No networks found</div>';
                            }
                        } else if (data.status === 'scanning') {
                            // Poll again in 1 second
                            setTimeout(pollScan, 1000);
                        }
                    })
                    .catch(err => {
                        list.innerHTML = '<div class="loading">Scan failed</div>';
                        console.error('Scan failed:', err);
                    });
            }

            pollScan();
        }

        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
            document.getElementById('password').focus();
        }

        function connectNetwork(event) {
            event.preventDefault();

            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);

            // Show persistent connecting message
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message info">
                <strong>Connecting to ${ssid}...</strong><br>
                <br>
                The device IP address will change. This page will lose connection.<br>
                <br>
                <strong>Next steps:</strong><br>
                1. Wait for the LED to turn <strong style="color: #28a745;">GREEN</strong> (connected)<br>
                2. Navigate to <strong>http://tinklink.local</strong><br>
                <br>
                If the LED turns <strong style="color: #dc3545;">RED</strong>, the connection failed.
                Reconnect to the TinkLink AP to try again.
            </div>`;

            fetch('/api/connect', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                }
                // Don't overwrite the persistent message on success
            })
            .catch(err => {
                // This is expected - connection will be lost
                console.log('Connection lost (expected when changing networks)');
            });

            return false;
        }

        function saveCredentials() {
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            if (!ssid) {
                showMessage('Please enter a network name', 'error');
                return;
            }

            // Show confirmation dialog
            if (!confirm(`Save WiFi credentials and connect to "${ssid}"?\n\nThe device will disconnect from the current network and the IP address will change.\n\nAfter connecting, use http://tinklink.local to access the device.`)) {
                return;
            }

            // Show persistent message
            const msg = document.getElementById('message');
            msg.innerHTML = `<div class="message info">
                <strong>Saving credentials and connecting to ${ssid}...</strong><br>
                <br>
                The device IP address will change. This page will lose connection.<br>
                <br>
                <strong>Next steps:</strong><br>
                1. Wait for the LED to turn <strong style="color: #28a745;">GREEN</strong> (connected)<br>
                2. Navigate to <strong>http://tinklink.local</strong><br>
                <br>
                If the LED turns <strong style="color: #dc3545;">RED</strong>, the connection failed.
                Reconnect to the TinkLink AP to try again.
            </div>`;

            const formData = new FormData();
            formData.append('ssid', ssid);
            formData.append('password', password);

            fetch('/api/save', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    // Also connect
                    connectNetwork(new Event('submit'));
                }
            })
            .catch(err => {
                // This is expected - connection will be lost
                console.log('Connection lost (expected when changing networks)');
            });
        }

        function disconnect() {
            fetch('/api/disconnect', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showMessage('Disconnected', 'info');
                    updateStatus();
                })
                .catch(err => console.error('Disconnect failed:', err));
        }

        // Update status on load and periodically
        updateStatus();
        setInterval(updateStatus, 3000);
    </script>
</body>
</html>
